FROM arm64v8/alpine
MAINTAINER https://github.com/rmcmillan34

# Install Bash and cleanup
RUN apk update && \
  apk add --no-cache bash

# Install OpenSSH and cleanup
RUN apk add --no-cache openssh
RUN echo 'PasswordAuthentication yes' >> /etc/ssh/sshd_config && \
  rm -rf /var/cache/apk/*

# Install Python3 and pip
RUN apk add --update --no-cache python3 && ln -sf python3 /usr/bin/python
RUN python3 -m ensurepip
RUN pip3 install --no-cache --upgrade pip setuptools

# Configure the root user password
RUN echo 'root:B4nd1t0' | chpasswd
# Change default shell to bash
#RUN sed -i 's/SHELL=\/bin\/sh/SHELL=\/bin\/bash/' /etc/default/useradd
#RUN chsh -s /bin/bash deploy

# Configure SSH for root user for administration purposes (Port 22)
RUN sed -i 's/#Port 22/Port 22/' /etc/ssh/sshd_config
RUN sed -i 's/#PermitRootLogin prohibit-password/PermitRootLogin yes/' /etc/ssh/sshd_config
EXPOSE 22

# Configure SSH for all Bandito levels to access and play the game (Port 2222)
RUN echo 'AllowUsers' >> /etc/ssh/sshd_config
RUN echo 'Port 2222' >> /etc/ssh/sshd_config
RUN echo 'PrintMotd yes' >> /etc/ssh/sshd_config
EXPOSE 2222

# Configure the SSH Banner /etc/banner (Shown before login)
RUN touch /etc/banner
RUN echo "\033[40m\033[31m ▄▄▄▄    ▄▄▄       ███▄    █ ▓█████▄  ██▓▄▄▄█████▓ ▒█████  \
▓█████▄ ▒████▄     ██ ▀█   █ ▒██▀ ██▌▓██▒▓  ██▒ ▓▒▒██▒  ██▒ \
▒██▒ ▄██▒██  ▀█▄  ▓██  ▀█ ██▒░██   █▌▒██▒▒ ▓██░ ▒░▒██░  ██▒ \
▒██░█▀  ░██▄▄▄▄██ ▓██▒  ▐▌██▒░▓█▄   ▌░██░░ ▓██▓ ░ ▒██   ██░ \
░▓█  ▀█▓ ▓█   ▓██▒▒██░   ▓██░░▒████▓ ░██░  ▒██▒ ░ ░ ████▓▒░ \
░▒▓███▀▒ ▒▒   ▓▒█░░ ▒░   ▒ ▒  ▒▒▓  ▒ ░▓    ▒ ░░   ░ ▒░▒░▒░  \
▒░▒   ░   ▒   ▒▒ ░░ ░░   ░ ▒░ ░ ▒  ▒  ▒ ░    ░      ░ ▒ ▒░  \
 ░    ░   ░   ▒      ░   ░ ░  ░ ░  ░  ▒ ░  ░      ░ ░ ░ ▒   \
 ░            ░  ░         ░    ░     ░               ░ ░   \
      ░                       ░                             \033[39m \
  This is an OverTheWire Bandit clone made in Alpine Linux \
     More info: https://github.com/rmcmillan34/bandito" >> /etc/banner


# Configure the SSH Message of the Day (MotD) /etc/motd (shown after successful login).
RUN touch /etc/motd
RUN echo "\033[40m\033[32m     ██▓███        █     █░      ███▄    █\n
    ▓██░  ██▒     ▓█░ █ ░█░      ██ ▀█   █\n
    ▓██░ ██▓▒     ▒█░ █ ░█      ▓██  ▀█ ██▒\n
    ▒██▄█▓▒ ▒     ░█░ █ ░█      ▓██▒  ▐▌██▒\n
    ▒██▒ ░  ░ ██▓ ░░██▒██▓  ██▓ ▒██░   ▓██░ ██▓\n
    ▒▓▒░ ░  ░ ▒▓▒ ░ ▓░▒ ▒   ▒▓▒ ░ ▒░   ▒ ▒  ▒▓▒\n
    ░▒ ░      ░▒    ▒ ░ ░   ░▒  ░ ░░   ░ ▒░ ░▒\n
    ░░        ░     ░   ░   ░      ░   ░ ░  ░\n
               ░      ░      ░           ░   ░\n
               ░             ░               ░\033[39m\n
Part of the project Portable Wargame NUC (PWN) series of CTF challenges \n
\n
--[ Playing the game ]--\n
\n
  This machine might hold several wargames.\n
  If you are playing "somegame", then:\n
\n
    * USERNAMES are somegame0, somegame1, ...\n
    * Most LEVELS are stored in /somegame/.\n
    * PASSWORDS for each level are stored in /etc/somegame_pass/.\n

  Write-access to homedirectories is disabled. It is advised to create a\n
  working directory with a hard-to-guess name in /tmp/.  You can use the\n
  command \"mktemp -d\" in order to generate a random and hard to guess\n
  directory in /tmp/.  Read-access to both /tmp/ is disabled and to /proc\n
  restricted so that users cannot snoop on eachother. Files and directories\n
  with easily guessable or short names will be periodically deleted! The /tmp\n
  directory is regularly wiped.\n
  Please play nice:\n
\n
    * don''t leave orphan processes running\n
    * dont''leave exploit-files laying around\n
    * don''t annoy other players\n
\n
\n
\n
--[ More information ]--\n
\n
  For more information regarding individual wargames, visit\n
  https://github.com/rmcmillan34/bandito \n
\n
  If you find a bug please feel free to raise an issue on the github above.\n
\n
  Enjoy your stay!" >> /etc/motd

# Generate SSH keys
RUN ssh-keygen -A

# Run Python scripts to create the player level environments.
COPY ./levels /app
RUN python3 /app/level0.py


CMD ["/usr/sbin/sshd", "-D"]



